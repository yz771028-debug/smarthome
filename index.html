<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>智慧居家監控系統</title>

<style>
body{
  margin:0;
  font-family:Arial;
  background:#0b1220;
  color:white;
  text-align:center;
}
.container{
  max-width:1000px;
  margin:40px auto;
}
.card{
  background:#111a2e;
  padding:20px;
  border-radius:12px;
  border:1px solid #223154;
  margin-bottom:20px;
}
.row{
  display:flex;
  gap:20px;
  flex-wrap:wrap;
  justify-content:center;
}
.box{
  flex:1 1 220px;
  background:#0f172a;
  padding:15px;
  border-radius:10px;
}
.value{
  font-size:32px;
  font-weight:bold;
}
.on{color:#2dd4bf;}
.off{color:#fb7185;}
button{
  padding:12px 25px;
  font-size:16px;
  border-radius:10px;
  border:none;
  cursor:pointer;
  background:#2563eb;
  color:white;
  margin-top:10px;
}
button.danger{
  background:#dc2626;
}
.small{
  font-size:12px;
  color:#9db0d6;
  margin-top:10px;
}
iframe{
  width:100%;
  height:260px;
  border-radius:10px;
  border:none;
  background:white;
  margin-top:10px;
}
</style>
</head>

<body>

<div class="container">

<h1>智慧居家監控系統</h1>

<!-- 即時感測器 -->
<div class="card">
<h2>即時感測器數據</h2>

<div class="row">
  <div class="box">
    溫度
    <div id="temp" class="value">--</div>
  </div>

  <div class="box">
    濕度
    <div id="humi" class="value">--</div>
  </div>

  <div class="box">
    瓦斯
    <div id="gas" class="value">--</div>
  </div>
</div>

</div>

<!-- 繼電器控制 -->
<div class="card">
<h2>繼電器控制</h2>

<div id="relayState" class="value">讀取中...</div>
<button id="toggleBtn">一鍵開關</button>

<div class="small">
命令來源：Channel 3277178 field1
</div>

</div>

<!-- 歷史圖表 -->
<div class="card">
<h2>歷史圖表（最近 20 筆）</h2>

<button id="resetViewBtn" class="danger">
⟳ 清除歷史資料
</button>

<div class="small">
僅重置顯示範圍為最近 20 筆，資料仍保留
</div>

溫度
<iframe id="chartT"></iframe>

濕度
<iframe id="chartH"></iframe>

瓦斯
<iframe id="chartG"></iframe>

</div>

</div>

<script>

// ===== Channel A（感測器）=====
const SENSOR_CHANNEL = 3271973;

// ===== Channel B（繼電器）=====
const CMD_CHANNEL = 3277178;
const CMD_WRITE_KEY = "OIX0C2JRKET8RVKK";
const CMD_READ_KEY  = "GXZB8HZNOGR3U2SH";

// 讀感測器
async function getSensors(){

  const url =
  `https://api.thingspeak.com/channels/${SENSOR_CHANNEL}/feeds/last.json`;

  const r = await fetch(url);
  const j = await r.json();

  document.getElementById("temp").innerHTML =
    j.field1 ? j.field1 + " °C" : "--";

  document.getElementById("humi").innerHTML =
    j.field2 ? j.field2 + " %" : "--";

  document.getElementById("gas").innerHTML =
    j.field3 ? j.field3 : "--";
}

// 讀繼電器
async function getRelay(){

  const url =
  `https://api.thingspeak.com/channels/${CMD_CHANNEL}/feeds/last.json?api_key=${CMD_READ_KEY}`;

  const r = await fetch(url);
  const j = await r.json();

  const val = j.field1 === "1" ? 1 : 0;

  renderRelay(val);
}

function renderRelay(v){

  const el = document.getElementById("relayState");

  if(v === 1){
    el.innerHTML = "ON";
    el.className = "value on";
    document.getElementById("toggleBtn").innerText = "按一下 → 關";
  }else{
    el.innerHTML = "OFF";
    el.className = "value off";
    document.getElementById("toggleBtn").innerText = "按一下 → 開";
  }

  window.currentRelay = v;
}

// 切換Relay
async function toggleRelay(){

  const next = window.currentRelay === 1 ? 0 : 1;

  const url =
  `https://api.thingspeak.com/update?api_key=${CMD_WRITE_KEY}&field1=${next}`;

  const r = await fetch(url);
  const result = await r.text();

  if(result === "0"){
    alert("請間隔 15 秒以上再操作");
  }

  setTimeout(getRelay, 1500);
}

// 圖表控制
function setChartsResults(n){

  const base =
  `https://thingspeak.com/channels/${SENSOR_CHANNEL}/charts/`;

  document.getElementById("chartT").src =
    `${base}1?dynamic=true&results=${n}`;

  document.getElementById("chartH").src =
    `${base}2?dynamic=true&results=${n}`;

  document.getElementById("chartG").src =
    `${base}3?dynamic=true&results=${n}`;
}

// 偽清除
document.getElementById("resetViewBtn")
.addEventListener("click", () => {

  setChartsResults(1);

  setTimeout(()=>setChartsResults(20),1000);
});

// 事件
document.getElementById("toggleBtn")
.addEventListener("click", toggleRelay);

// 初始化
setChartsResults(20);
getSensors();
getRelay();

// 每 5 秒更新
setInterval(getSensors,5000);
setInterval(getRelay,5000);

</script>

</body>
</html>
