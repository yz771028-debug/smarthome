<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>智慧居家繼電器控制</title>

<style>
body{
  margin:0;
  font-family:Arial;
  background:#0b1220;
  color:white;
  text-align:center;
}
.container{
  max-width:600px;
  margin:50px auto;
}
.card{
  background:#111a2e;
  padding:20px;
  border-radius:12px;
  border:1px solid #223154;
  margin-bottom:20px;
}
.status{
  font-size:40px;
  font-weight:bold;
}
.on{color:#2dd4bf;}
.off{color:#fb7185;}
button{
  padding:15px 25px;
  font-size:18px;
  border-radius:10px;
  border:none;
  cursor:pointer;
  background:#2563eb;
  color:white;
}
button:disabled{
  opacity:0.5;
}
.small{
  font-size:12px;
  color:#9db0d6;
  margin-top:10px;
}
</style>
</head>

<body>

<div class="container">

<div class="card">
<h2>繼電器遠端控制</h2>

<div id="relayState" class="status">讀取中...</div>

<button id="toggleBtn">一鍵開關</button>

<div class="small">
命令來源：ThingSpeak Channel 3277178 field1
</div>

</div>

</div>

<script>

// ====== 你的命令 Channel ======
const CHANNEL_ID = 3277178;
const WRITE_KEY  = "OIX0C2JRKET8RVKK";   // ⚠️ 已公開
const READ_KEY   = "GXZB8HZNOGR3U2SH";

// 讀目前狀態
async function getState(){

  const url =
  `https://api.thingspeak.com/channels/${CHANNEL_ID}/feeds/last.json?api_key=${READ_KEY}`;

  const r = await fetch(url);
  const j = await r.json();

  const val = j.field1 === "1" ? 1 : 0;

  renderState(val);
}

// 畫面顯示
function renderState(v){

  const el = document.getElementById("relayState");

  if(v === 1){
    el.innerHTML = "ON";
    el.className = "status on";
    document.getElementById("toggleBtn").innerText = "按一下 → 關";
  }else{
    el.innerHTML = "OFF";
    el.className = "status off";
    document.getElementById("toggleBtn").innerText = "按一下 → 開";
  }

  window.currentState = v;
}

// 切換狀態
async function toggleRelay(){

  const btn = document.getElementById("toggleBtn");
  btn.disabled = true;

  const next = window.currentState === 1 ? 0 : 1;

  const url =
  `https://api.thingspeak.com/update?api_key=${WRITE_KEY}&field1=${next}`;

  const r = await fetch(url);
  const result = await r.text();

  if(result === "0"){
    alert("寫入失敗（可能 15 秒限制），請等一下再試");
  }

  setTimeout(getState, 1500);

  btn.disabled = false;
}

// 事件綁定
document.getElementById("toggleBtn").addEventListener("click", toggleRelay);

// 初始讀取
getState();

// 每 5 秒更新一次狀態
setInterval(getState, 5000);

</script>

</body>
</html>
